<template>
  <div class="desktop-knowledge-view">
    <div class="desktop-layout">
      <!-- 模块导航 -->
      <nav class="module-sidebar">
        <button
          v-for="module in modules"
          :key="module.id"
          class="module-sidebar__item"
          :class="{ active: activeModule === module.id }"
          type="button"
          @click="selectModule(module.id)"
        >
          <Icon :icon="module.icon" class="module-sidebar__icon" />
          <span class="module-sidebar__text">{{ module.label }}</span>
        </button>
      </nav>

      <div class="module-content">
        <template v-if="activeModule === 'latest'">
          <div class="latest-module">
            <aside 
              class="latest-sidebar"
              :class="{ collapsed: sidebarCollapsed }"
              :style="{ width: SIDEBAR_WIDTH + 'px' }"
            >
              <div class="latest-root">
                <div class="latest-root__leading">
                  <span class="latest-root__icon">
                    <Icon icon="mdi:update" />
                  </span>
                  <span class="latest-root__label">最新文档</span>
                </div>
                <div class="latest-root__meta">共 {{ latestTotal }} 篇</div>
              </div>

              <div class="latest-doc-list" data-scroll ref="latestListRef">
                <div v-if="latestLoading && !latestDocs.length" class="latest-status">
                  <Icon icon="mdi:loading" class="spin" />
                  <span>正在加载最新内容...</span>
                </div>

                <div v-else-if="latestError && !latestDocs.length" class="latest-status latest-status--error">
                  <Icon icon="mdi:alert-circle-outline" />
                  <span>{{ latestError }}</span>
                  <button type="button" class="latest-status__action" @click="refreshLatestDocs">
                    重试
                  </button>
                </div>

                <div v-else-if="!latestLoading && latestDocs.length === 0" class="latest-status latest-status--empty">
                  <Icon icon="mdi:file-search-outline" />
                  <span>这里还没有文档</span>
                  <p>稍后再来看看最新更新吧。</p>
                </div>

                <template v-else>
                  <button
                    v-for="doc in latestDocs"
                    :key="doc.id"
                    class="latest-doc-item"
                    :class="{ active: currentDocId === doc.id }"
                    type="button"
                    @click="selectLatestDoc(doc.id)"
                  >
                    <div class="latest-doc-item__title" :title="doc.title">
                      {{ doc.title || '未命名文档' }}
                    </div>
                    <div class="latest-doc-item__meta">
                      更新于 {{ formatDate(doc.updatedAt || doc.createdAt) }}
                    </div>
                  </button>
                </template>

                <InfiniteFooterBar :state="latestBarState" @retry="retryLatestLoad" />
                <div ref="latestSentinelRef" class="latest-sentinel" />
              </div>

            </aside>

            <DesktopSidebarHandle 
              :collapsed="sidebarCollapsed"
              :width="SIDEBAR_WIDTH"
              @toggle="toggleSidebar"
            />

            <main class="desktop-content">
              <DesktopDocWorkspace
                empty-title="选择一个最新文档"
                empty-description="在左侧“最新文档”列表中挑选内容，内容将展示在这里。"
              />
            </main>
          </div>
        </template>

        <template v-else-if="activeModule === 'document'">
          <!-- 文档模块：知识库原有布局 -->
          <div class="doc-module">
            <aside 
              class="desktop-sidebar" 
              :class="{ collapsed: sidebarCollapsed }"
              :style="{ width: SIDEBAR_WIDTH + 'px' }"
            >
              <DesktopDocTree />
            </aside>

            <DesktopSidebarHandle 
              :collapsed="sidebarCollapsed"
              :width="SIDEBAR_WIDTH"
              @toggle="toggleSidebar"
            />

            <main class="desktop-content">
              <DesktopDocWorkspace />
            </main>
          </div>
        </template>

        <template v-else>
          <div class="module-placeholder">
            <Icon :icon="activeModuleMeta?.icon" class="module-placeholder__icon" />
            <h3>{{ activeModuleMeta?.label }}模块建设中</h3>
            <p>敬请期待，更多能力即将上线。</p>
          </div>
        </template>
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed, onMounted, onUnmounted, reactive, ref, watch } from 'vue';
import { Icon } from '@iconify/vue';
import { useUiStore } from '../../stores/ui';
import { useTreeStore } from '../../stores/tree';
import { useDocStore } from '../../stores/doc';
import DesktopDocTree from '../../components/desktop/DesktopDocTree.vue';
import DesktopDocWorkspace from '../../components/desktop/DesktopDocWorkspace.vue';
import DesktopSidebarHandle from '../../components/desktop/DesktopSidebarHandle.vue';
import InfiniteFooterBar from '../../components/shared/InfiniteFooterBar.vue';
import { SYNC_STATUS } from '../../constants';
import { formatDate } from '@/utils/formatters';
import { fetchDocumentsService } from '../../services/documentService';
import { useInfiniteLoader } from '@/composables/useInfiniteLoader';

const uiStore = useUiStore();
const treeStore = useTreeStore();
const docStore = useDocStore();

const SIDEBAR_WIDTH = 280;
const LATEST_PAGE_SIZE = 20;
const MODULES = [
  {
    id: 'latest',
    label: '最新',
    icon: 'mdi:clock-time-eight-outline',
  },
  {
    id: 'document',
    label: '文档',
    icon: 'mdi:file-document-multiple-outline',
  },
];

const activeModule = ref(MODULES[0].id);
const activeModuleMeta = computed(() => MODULES.find((module) => module.id === activeModule.value));
const modules = MODULES;

const moduleDocState = reactive(
  MODULES.reduce((acc, module) => {
    acc[module.id] = null;
    return acc;
  }, {})
);

const sidebarCollapsed = computed(() => uiStore.sidebarCollapsed);
const currentDocId = computed(() => docStore.currentDoc?.id ?? null);

const latestDocs = ref([]);
const latestLoading = ref(false);
const latestError = ref('');
const latestHasMore = ref(false);
const latestNextCursor = ref(null);
const latestTotal = ref(0);
const latestListRef = ref(null);
const latestBarState = ref('idle');

function toggleSidebar() {
  uiStore.toggleSidebar();
}

function selectModule(moduleId) {
  if (activeModule.value === moduleId) return;

  const previousModule = activeModule.value;
  if (previousModule && previousModule in moduleDocState) {
    moduleDocState[previousModule] = docStore.currentDoc?.id ?? null;
  }

  activeModule.value = moduleId;
  if (moduleId in moduleDocState) {
    restoreModuleWorkspace(moduleId);
  } else {
    docStore.closeDoc();
  }
}

async function restoreModuleWorkspace(moduleId) {
  const targetDocId = moduleDocState[moduleId];
  if (targetDocId && docStore.currentDoc?.id !== targetDocId) {
    try {
      await docStore.openDoc(targetDocId);
    } catch (error) {
      uiStore.showError(error.message || '打开文档失败');
      moduleDocState[moduleId] = null;
      docStore.closeDoc();
    }
  } else if (!targetDocId) {
    docStore.closeDoc();
  }
}

async function selectLatestDoc(docId) {
  if (!docId) return;
  treeStore.selectNode(docId, 'document');
  try {
    await docStore.openDoc(docId);
  } catch (error) {
    uiStore.showError(error.message || '打开文档失败');
  }
}

function replaceLatestDocs(items = []) {
  latestDocs.value.splice(0, latestDocs.value.length, ...items);
}

function appendLatestDocs(items = []) {
  if (!items.length) return;
  items.forEach((item) => {
    const existingIdx = latestDocs.value.findIndex((doc) => doc.id === item.id);
    if (existingIdx !== -1) {
      latestDocs.value.splice(existingIdx, 1);
    }
    latestDocs.value.push(item);
  });
}

async function fetchLatestDocs({ reset = false } = {}) {
  if (latestLoading.value) return;
  latestLoading.value = true;
  latestError.value = '';

  if (reset) {
    replaceLatestDocs();
    latestNextCursor.value = null;
    latestHasMore.value = false;
  }

  try {
    const params = {
      limit: LATEST_PAGE_SIZE,
      sortBy: 'updatedAt',
      order: 'desc',
    };

    if (!reset && latestNextCursor.value) {
      params.cursor = latestNextCursor.value;
    }

    const result = await fetchDocumentsService(params);
    const items = result.items || [];

    if (reset) {
      replaceLatestDocs(items);
    } else {
      appendLatestDocs(items);
    }

    latestNextCursor.value = result.pagination?.nextCursor ?? null;
    latestHasMore.value = result.pagination?.hasMore ?? false;
    latestTotal.value = result.pagination?.total ?? latestDocs.value.length;
  } catch (error) {
    console.error('Failed to fetch latest documents:', error);
    latestError.value = error.message || '加载最新文档失败';
    throw error;
  } finally {
    latestLoading.value = false;
  }
}

function refreshLatestDocs() {
  fetchLatestDocs({ reset: true }).catch(() => {});
}

function loadMoreLatest() {
  if (!latestHasMore.value || latestLoading.value) return;
  return fetchLatestDocs();
}

function promoteLatestDoc(doc) {
  if (!doc?.id) return;

  const updatedDoc = {
    ...doc,
    updatedAt: doc.updatedAt ?? docStore.currentDoc?.updatedAt ?? new Date().toISOString(),
  };

  const docs = latestDocs.value;
  const previousLength = docs.length;
  const existingIdx = docs.findIndex((item) => item.id === updatedDoc.id);
  const existed = existingIdx !== -1;

  if (existed) {
    docs.splice(existingIdx, 1);
  } else if (latestTotal.value !== null && latestTotal.value !== undefined) {
    latestTotal.value += 1;
  } else {
    latestTotal.value = previousLength + 1;
  }

  docs.unshift(updatedDoc);

  if (!existed && previousLength > 0 && docs.length > previousLength && latestHasMore.value) {
    docs.pop();
  }
}

const { sentinelRef: latestSentinelRef, barState: latestBarStateFromLoader, retry: retryLoadMoreLatest } = useInfiniteLoader({
  containerRef: latestListRef,
  hasMore: latestHasMore,
  loading: latestLoading,
  enabled: computed(() => activeModule.value === 'latest'),
  loadMore: loadMoreLatest,
});

watch(
  () => latestBarStateFromLoader.value,
  (state) => {
    latestBarState.value = state;
  },
  { immediate: true }
);

function retryLatestLoad() {
  retryLoadMoreLatest();
}

watch(
  () => docStore.currentDoc?.id ?? null,
  (docId) => {
    if (activeModule.value in moduleDocState) {
      moduleDocState[activeModule.value] = docId ?? null;
    }
  }
);

watch(
  () => docStore.syncStatus,
  (status, prev) => {
    if (status === SYNC_STATUS.SYNCED && prev !== SYNC_STATUS.SYNCED && docStore.currentDoc) {
      promoteLatestDoc(docStore.currentDoc);
    }
  }
);

// 处理窗口大小变化
function handleWindowResize() {
  uiStore.initSidebar();
}

onMounted(async () => {
  // 初始化侧边栏状态
  uiStore.initSidebar();
  
  // 监听窗口大小变化
  window.addEventListener('resize', handleWindowResize);
  
  try {
    await treeStore.fetchTree();
  } catch (error) {
    // 401错误在request拦截器中已处理
    if (error.code !== 401) {
      uiStore.showError(error.message || '加载数据失败');
    }
  }
});

onUnmounted(() => {
  window.removeEventListener('resize', handleWindowResize);
});

watch(
  () => activeModule.value,
  (module) => {
    if (module === 'latest' && latestDocs.value.length === 0 && !latestLoading.value) {
      refreshLatestDocs();
    }
  },
  { immediate: true }
);
</script>

<style scoped>
.desktop-knowledge-view {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.desktop-layout {
  flex: 1;
  display: flex;
  overflow: hidden;
  min-height: 0;
  position: relative;
}

.module-sidebar {
  flex: 0 0 71px;
  background: #ffffff;
  border-right: 1px solid rgba(15, 23, 42, 0.08);
  display: flex;
  flex-direction: column;
  padding: 16px 5px;
  gap: 12px;
}

.module-sidebar__item {
  width: 100%;
  padding: 10px 10px;
  border: 1px solid transparent;
  border-radius: 16px;
  background: transparent;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: all 0.2s ease;
}

.module-sidebar__item:hover {
  background: rgba(99, 102, 241, 0.1);
  color: var(--color-text-primary);
}

.module-sidebar__item.active {
  background: var(--color-surface-elevated, #ffffff);
  border-color: rgba(99, 102, 241, 0.35);
  color: var(--color-text-primary);
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
}

.module-sidebar__icon {
  font-size: calc(22px);
}

.module-sidebar__text {
  font-size: 11px;
  font-weight: 400;
}

.module-content {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  position: relative;
}

.doc-module {
  flex: 1;
  display: flex;
  gap: 0;
  overflow: hidden;
  min-height: 0;
  position: relative;
}

.desktop-sidebar {
  position: relative;
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: #ffffff;
  box-shadow: 4px 0 16px -2px rgba(0, 0, 0, 0.08), 6px 0 24px -2px rgba(0, 0, 0, 0.06);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  flex-shrink: 0;
  z-index: 10;
}

.desktop-sidebar.collapsed {
  width: 0 !important;
  opacity: 0;
  overflow: hidden;
}

.desktop-content {
  position: relative;
  flex: 1;
  height: 100%;
  overflow: hidden;
  background: var(--color-bg-primary);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.module-placeholder {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  color: var(--color-text-secondary);
  background: var(--color-bg-primary);
  text-align: center;
}

.module-placeholder__icon {
  font-size: 48px;
  color: var(--color-text-primary);
}

.latest-module {
  display: flex;
  flex: 1;
  min-height: 0;
  overflow: hidden;
  position: relative;
}

.latest-sidebar {
  position: relative;
  width: 280px;
  background: #ffffff;
  border-right: 1px solid rgba(15, 23, 42, 0.08);
  display: flex;
  flex-direction: column;
  padding: 20px 10px;
  gap: 16px;
  flex-shrink: 0;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 4px 0 16px -2px rgba(0, 0, 0, 0.08), 6px 0 24px -2px rgba(0, 0, 0, 0.06);
  z-index: 10;
}

.latest-sidebar.collapsed {
  width: 0 !important;
  opacity: 0;
  overflow: hidden;
  padding: 0;
}

.latest-root {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.latest-root__leading {
  display: flex;
  align-items: center;
  gap: 8px;
}

.latest-root__icon {
  width: 32px;
  height: 32px;
  border-radius: 10px;
  background: rgba(99, 102, 241, 0.12);
  display: flex;
  align-items: center;
  justify-content: center;
  color: rgba(99, 102, 241, 1);
}

.latest-root__label {
  font-size: 15px;
  font-weight: 600;
  color: var(--color-text-primary);
}

.latest-root__meta {
  font-size: 12px;
  color: var(--color-text-tertiary);
}

.latest-doc-list {
  flex: 1;
  overflow: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding-right: 6px;
}

.latest-sentinel {
  height: 1px;
}

.latest-doc-item {
  width: 100%;
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid transparent;
  text-align: left;
  background: transparent;
  display: flex;
  flex-direction: column;
  gap: 6px;
  color: var(--color-text-secondary);
  transition: all 0.2s ease;
  cursor: pointer;
}

.latest-doc-item:hover {
  background: rgba(99, 102, 241, 0.1);
  color: var(--color-text-primary);
}

.latest-doc-item.active {
  background: rgba(99, 102, 241, 0.12);
  border-color: rgba(99, 102, 241, 0.4);
  color: var(--color-text-primary);
}

.latest-doc-item__title {
  font-size: 14px;
  font-weight: 600;
  line-height: 1.4;
  color: inherit;
}

.latest-doc-item__meta {
  font-size: 12px;
  color: var(--color-text-tertiary);
}

/* 暗色主题 */
[data-theme='dark'] .desktop-sidebar {
  background: #1f2937;
  box-shadow: 4px 0 16px -2px rgba(0, 0, 0, 0.3), 6px 0 24px -2px rgba(0, 0, 0, 0.2);
}

[data-theme='dark'] .module-sidebar {
  background: #ffffff;
  border-right-color: rgba(148, 163, 184, 0.15);
}

[data-theme='dark'] .module-sidebar__item.active {
  background: rgba(148, 163, 184, 0.08);
}

[data-theme='dark'] .latest-sidebar {
  background: #111827;
  border-right-color: rgba(148, 163, 184, 0.2);
  box-shadow: 4px 0 16px -2px rgba(0, 0, 0, 0.4), 6px 0 24px -2px rgba(0, 0, 0, 0.3);
}

[data-theme='dark'] .latest-doc-item {
  color: #e5e7eb;
}

[data-theme='dark'] .latest-doc-item__meta {
  color: #9ca3af;
}

[data-theme='dark'] .latest-doc-item.active {
  background: rgba(99, 102, 241, 0.2);
  border-color: rgba(99, 102, 241, 0.5);
}

[data-theme='dark'] .module-placeholder {
  background: #0f172a;
}
</style>

